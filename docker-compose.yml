services:
  # Astral Discord Bot
  astral-bot:
    build: ./bot
    container_name: astral-bot
    env_file: .env
    environment:
      # Use host Ollama (models already downloaded locally)
      - OLLAMA_HOST=http://host.docker.internal:11434
      - OLLAMA_MODEL=${LMSTUDIO_CHAT_MODEL}
      - LMSTUDIO_CHAT_MODEL=${LMSTUDIO_CHAT_MODEL}
      - SEARXNG_HOST=http://searxng:8080
      - RAG_DATABASE=/app/data/db/memory.db
      - CHARACTERS_FILE=/app/data/characters.json
      - ASSETS_DIR=/app/data/assets
      - KOKORO_TTS_URL=http://host.docker.internal:8000
      - PYTHONUNBUFFERED=1 # Enable real-time logging
    depends_on:
      searxng:
        condition: service_started
    volumes:
      - ./bot:/app # Live code mount (overlay entire app for hot reload)
      - ./db:/app/data/db # Persist RAG database
    restart: unless-stopped
    networks:
      - astral-network
    # Allow access to host network on Windows Docker
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # SearXNG - Free Unlimited Search
  searxng:
    image: searxng/searxng:latest
    container_name: astral-searxng
    ports:
      - "8080:8080"
    volumes:
      - ./searxng:/etc/searxng:rw
    environment:
      - SEARXNG_BASE_URL=http://localhost:8080
    restart: unless-stopped
    networks:
      - astral-network

networks:
  astral-network:
    driver: bridge
